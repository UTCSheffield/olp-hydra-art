<!DOCTYPE html>
<html lang="en">

<head>
  <title>hydra inside a webpage</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="refresh" content="30">

  <!-- import the webpage's stylesheet -->
  <link rel="stylesheet" href="style.css" />

  <!-- import the latest version of hydra synth-->
  <script src="https://unpkg.com/hydra-synth"></script>
  <!--<script src="https://cdn.statically.io/gl/metagrowing/extra-shaders-for-hydra/main/lib/lib-color.js"></script>-->
</head>

<body>
  <div id="ncid-c50a">
    <canvas id="hydra-canvas" width="1275" height="641" class="bg-black"></canvas>
    <pre id="editor-container"></pre>
  </div>

  <script>
    // create a new hydra-synth instance
    var hydra = new Hydra({
      canvas: document.getElementById("hydra-canvas"),
      detectAudio: false,
    });

    function getRandomInt(max) {
      return Math.floor(Math.random() * max);
    }

    // licensed with CC BY-NC-SA 4.0 https://creativecommons.org/licenses/by-nc-sa/4.0/
    // UTC OLP Hex Color List shader
    // licensed with CC BY-NC-SA 4.0 https://creativecommons.org/licenses/by-nc-sa/4.0/
    // UTC OLP Hex Color List shader

    const colors2glsl = (hex_codes) => {
      let i = 1
      var s = `
  const float d3 = 1.0 / 3.0;
  float gray = d3 * (_c0.r + _c0.g + _c0.b);
  float factor = 0.0;
  vec3 co;
  `

      var hex_code_list = hex_codes.split(",")

      s += "const float colorCount = " + (hex_code_list.length) + ".0;\n"

      hex_code_list.forEach((hex) => {
        if (i > 1) {
          s += "else "
        }
        if (i < hex_code_list.length) {
          s += "if "
          s += "(gray < " + (i / hex_code_list.length) + ")"
        }

        s += "{\n"
        s += " factor = (1.0+((variation/2.0)*((colorCount*gray)-0.5))) ;\n"
        s += " co.r = factor * " + (parseInt(hex.slice(1, 3), 16) / 255).toFixed(10) + ";\n"
        s += " co.g = factor * " + (parseInt(hex.slice(3, 5), 16) / 255).toFixed(10) + ";\n"
        s += " co.b = factor * " + (parseInt(hex.slice(5, 7), 16) / 255).toFixed(10) + ";\n"
        s += "}\n"
        i += 1;
      });

      s += `
  return vec4(amount * clamp(co, 0.0, 1.0) + (1.0 - amount) * _c0.rgb, _c0.a);
`

      //console.log(s)

      return {
        name: 'colours',
        type: 'color',
        inputs: [
          { name: 'amount', type: 'float', default: 1.0 },
          { name: 'variation', type: 'float', default: 0.1 },
        ],
        glsl: s
      };
    }

    let aImages = [
      "https://th.bing.com/th/id/OIP.2stYdpfk62fcRZIl9Lr3HAHaFW?rs=1&pid=ImgDetMain",
      //"https://th.bing.com/th/id/R.cad1ba09a5482a609f99e2c06a33d4cf?rik=4OiPf5icmMeWOQ&riu=http%3a%2f%2ffarm7.staticflickr.com%2f6041%2f6265559256_2ddef4556b_z.jpg",
      "https://th.bing.com/th/id/OIP.PtTWJAKDjQS-02KNcxEEJAAAAA?rs=1&pid=ImgDetMain",
      "https://upload.wikimedia.org/wikipedia/commons/a/ad/Ada_lovelace_10k_31i.png",
      "https://upload.wikimedia.org/wikipedia/commons/0/0e/Analog_Computing_Machine_GPN-2000-000354.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/6/65/%27bombe%27.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/2/24/Women_holding_parts_of_the_first_four_Army_computers.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/5/5d/Charles-babbage.intel.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/5/5c/Bombe-rebuild.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/f/f8/Alan_Turing_%281951%29.jpg",
      "https://static.independent.co.uk/s3fs-public/thumbnails/image/2020/03/01/12/katherine-johnson.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/6/62/Katherine_Johnson_at_NASA%2C_in_1966.jpg",
    ]

    aImages.sort(() => Math.random() - 0.5);

    s0.initImage(aImages.pop());
    s1.initImage(aImages.pop());
    s2.initImage(aImages.pop());

    function maybeModifyScript(text) {
      // Do not modify if colors2glsl is already present
      if (/colors2glsl\s*\(/.test(text)) {
        return text;
      }
      if (Math.random() < 0.25) {
        // Replace the last occurrence of .out( with .colours(1).out(
        const lastOutRegex = /(.out\s*\()/g;
        let match;
        let lastIndex = -1;
        while ((match = lastOutRegex.exec(text)) !== null) {
          lastIndex = match.index;
        }
        if (lastIndex !== -1) {
          // Only replace if not already preceded by .colours(1)
          const before = text.slice(0, lastIndex);
          const after = text.slice(lastIndex);
          if (!before.endsWith('.colours(1)')) {
            // Add setFunction(colors2glsl(...)) at the top
            return 'setFunction(colors2glsl("#ee7d00,#009bb4,#e0d3e6,#006F81"))\n' + before + '.colours(1)' + after;
          }
        }
      }
      return text;
    }


    // Load student file list from students.json and pick one at random
    fetch('students.json')
      .then(response => response.json())
      .then(studentFiles => {
        if (!Array.isArray(studentFiles) || studentFiles.length === 0) {
          document.getElementById("editor-container").textContent = '// No student files found.';
          return;
        }
        const chosen = studentFiles[getRandomInt(studentFiles.length)];
        fetch(chosen)
          .then(response => response.text())
          .then(text => {
            // Optionally modify the loaded script for both execution and display
            const modifiedText = maybeModifyScript(text);
            document.getElementById("editor-container").textContent = '// Loaded: ' + chosen + '\n' + modifiedText;
            // Execute the modified code
            try {
              eval(modifiedText);
            } catch (e) {
              document.getElementById("editor-container").textContent += '\n// Error executing script: ' + e;
            }
          })
          .catch(() => {
            document.getElementById("editor-container").textContent = '// Loaded: ' + chosen + '\n// (Could not load content)';
          });
      })
      .catch(() => {
        document.getElementById("editor-container").textContent = '// Could not load students.json';
      });

  </script>
</body>

</html>